name: Build macOS App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Build Release
        run: |
          xcodebuild \
            -project PakScape.xcodeproj \
            -scheme PakScape \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      - name: Package App
        run: |
          APP_PATH="build/Build/Products/Release/PakScape.app"
          DMG_NAME="PakScape.dmg"
          STAGING_DIR="dmg_staging"

          if [ ! -d "$APP_PATH" ]; then
            echo "App bundle not found at $APP_PATH"
            exit 1
          fi

          rm -rf "$STAGING_DIR"
          mkdir "$STAGING_DIR"
          ditto "$APP_PATH" "$STAGING_DIR/PakScape.app"

          hdiutil create "$DMG_NAME" \
            -volname "PakScape" \
            -srcfolder "$STAGING_DIR" \
            -ov \
            -format UDZO

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: PakScape
          path: PakScape.dmg
